language: go
go:
  - "1.13"
os: linux
dist: bionic

addons:
  apt:
    update: true
    packages:
      - docker-ce

services:
  - docker

branches:
  only:
    - master
    - experimental

env:
  global:
    - REPO=iceflower/redeclipse-server
    - USER=iceflower
    - ARCH=amd64
    - HASH_URL=https://api.iceflower.eu/webhook/github/redeclipse/base/hash

jobs:
  include:
    - stage: "build"
      name: "updater"
      before_script: skip
      script:
        - cd go-github-webhook
        - go build -x -o updater ./cmd/updater/
      after_script: skip
    -
      name: "server"
      before_script: skip
      script:
        - cd go-github-webhook
        - go build -x -o server ./cmd/server/
      after_script: skip
    - stage: "update"
      name: "refs/heads/master"
      env:
        - DOCKERFILE=Dockerfile_master
    -
      name: "refs/heads/stable"
      env:
        - DOCKERFILE=Dockerfile_stable
    -
      name: "refs/tags/v1.5.3"
      env:
        - DOCKERFILE=Dockerfile_stable
    -
      name: "refs/tags/v1.5.5"
      env:
        - DOCKERFILE=Dockerfile_stable
    -
      name: "refs/tags/v1.5.6"
      env:
        - DOCKERFILE=Dockerfile_stable
    -
      name: "refs/tags/v1.5.8"
      env:
        - DOCKERFILE=Dockerfile_stable
    -
      name: "refs/tags/v1.6.0"
      env:
        - DOCKERFILE=Dockerfile_stable
    -
      name: "refs/tags/v2.0.0"
      env:
        - DOCKERFILE=Dockerfile_master

install:
  - mkdir -p ~/.docker/
  - bash ./ci/enable-experimental-docker.sh

script:
  - cd go-github-webhook
  - go build -x -o ../updater ./cmd/updater/
  - cd ../
  - ./updater --dockerfile $DOCKERFILE --ref $TRAVIS_JOB_NAME --arch $ARCH --repo $REPO --user $USER --password $DOCKER_PASSWORD --hashUrl $HASH_URL --apiKey $HASH_API_KEY ./

after_script:
  - docker logout
