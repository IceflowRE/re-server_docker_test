language: go
go:
  - "1.13"
os: linux
dist: bionic

addons:
  apt:
    update: true
    packages:
      - docker-ce

services:
  - docker

branches:
  only:
    - master
    - experimental

before_cache:
  - rm ~/.rsd-updater/$TRAVIS_JOB_NAME/Dockerfile_master
  - rm ~/.rsd-updater/$TRAVIS_JOB_NAME/Dockerfile_stable
  - rm ~/.rsd-updater/$TRAVIS_JOB_NAME/.dockerignore
  - rm ~/.rsd-updater/$TRAVIS_JOB_NAME/updater

cache:
  directories:
    - ~/.rsd-updater/$TRAVIS_JOB_NAME/

env:
  global:
    - REPO=iceflower/redeclipse-server
    - USER=iceflower
    - ARCH=amd64

jobs:
  include:
    - stage: "build"
      name: "updater"
      before_script: skip
      script:
        - cd go-github-webhook
        - go build -x -o updater ./cmd/updater/
      after_script: skip
    -
      script:
        - cd go-github-webhook
        - go build -x -o server ./cmd/server/
      name: "server"
      before_script: skip
      after_script: skip
    - stage: "update"
      name: "refs/heads/master"
      env:
        - DOCKERFILE=Dockerfile_master
    -
      name: "refs/heads/stable"
      env:
        - DOCKERFILE=Dockerfile_stable
    -
      name: "refs/tags/v1.5.3"
      env:
        - DOCKERFILE=Dockerfile_stable
    -
      name: "refs/tags/v1.5.5"
      env:
        - DOCKERFILE=Dockerfile_stable
    -
      name: "refs/tags/v1.5.6"
      env:
        - DOCKERFILE=Dockerfile_stable
    -
      name: "refs/tags/v1.5.8"
      env:
        - DOCKERFILE=Dockerfile_stable
    -
      name: "refs/tags/v1.6.0"
      env:
        - DOCKERFILE=Dockerfile_stable
    -
      name: "refs/tags/v2.0.0"
      env:
        - DOCKERFILE=Dockerfile_master

install:
  - mkdir -p ~/.docker/
  - bash ./ci/enable-experimental-docker.sh

before_script:
  - cd ./go-github-webhook
  - go build -x -o updater ./cmd/updater/
  - cd ..
  - mkdir -p ~/.rsd-updater/$TRAVIS_JOB_NAME
  - cp Dockerfile_stable ~/.rsd-updater/$TRAVIS_JOB_NAME/
  - cp Dockerfile_master ~/.rsd-updater/$TRAVIS_JOB_NAME/
  - cp .dockerignore ~/.rsd-updater/$TRAVIS_JOB_NAME/
  - cp ./go-github-webhook/updater ~/.rsd-updater/$TRAVIS_JOB_NAME/

script:
  - cd ~/.rsd-updater/$TRAVIS_JOB_NAME/
  - ./updater --dockerfile $DOCKERFILE --ref $TRAVIS_JOB_NAME --arch $ARCH --repo $REPO --user $USER --password $DOCKER_PASSWORD ./

after_script:
  - docker logout
